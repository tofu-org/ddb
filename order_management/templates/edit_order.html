{% extends "base.html" %}

{% block title %}
    {% if order %}–ó–∞–∫–∞–∑ {{ order.order_number }}{% else %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>
        {% if order %}
            {% if editable %}üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä{% endif %} –∑–∞–∫–∞–∑–∞ {{ order.order_number }}
        {% endif %}
    </h2>
</div>

<form method="POST" class="order-form">
    <div class="form-section">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
        
        <div class="info-row">
            <div class="info-item">
                <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:</label>
                <div class="info-value">{{ order.client.name }}</div>
            </div>
            
            <div class="info-item">
                <label>Email:</label>
                <div class="info-value">{{ order.client.email }}</div>
            </div>
            
            <div class="info-item">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <div class="info-value">{{ order.client.phone_number }}</div>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
        
        <div class="info-row">
            <div class="info-item">
                <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</label>
                <div class="info-value"><strong>{{ order.order_number }}</strong></div>
            </div>
            
            <div class="info-item">
                <label>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</label>
                <div class="info-value">
                    {% if order.date_of_order %}
                        {{ order.date_of_order.strftime('%d.%m.%Y') }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="shop_id">–ú–∞–≥–∞–∑–∏–Ω:</label>
                <select id="shop_id" name="shop_id" {% if not editable %}disabled{% endif %}>
                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                    {% for shop in shops %}
                    <option value="{{ shop.id }}" 
                            {% if order.shop_id == shop.id %}selected{% endif %}>
                        {{ shop.name }} - {{ shop.address }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            {% if user_type == 'staff' %}
            <div class="form-group">
                <label for="worker_id">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
                <select id="worker_id" name="worker_id" {% if not editable %}disabled{% endif %}>
                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                    {% for worker in workers %}
                    <option value="{{ worker.id }}"
                            {% if order.receipt and order.receipt.shop_workerid == worker.id %}selected{% endif %}>
                        {{ worker.name }} ({{ worker.position }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="total_price">–û–±—â–∞—è —Å—É–º–º–∞ (‚ÇΩ):</label>
                <input type="number" id="total_price" name="total_price" step="0.01" min="0"
                       value="{{ order.total_price if order.total_price else 0 }}" 
                       {% if not editable %}readonly{% endif %}>
            </div>
            
            {% if user_type == 'staff' %}
            <div class="form-group">
                <label for="status">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</label>
                <select id="status" name="status" {% if not editable %}disabled{% endif %}>
                    <option value="–ù–æ–≤—ã–π" {% if order.status == '–ù–æ–≤—ã–π' %}selected{% endif %}>–ù–æ–≤—ã–π</option>
                    <option value="–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è" {% if order.status == '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option>
                    <option value="–í –æ–±—Ä–∞–±–æ—Ç–∫–µ" {% if order.status == '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' %}selected{% endif %}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                    <option value="–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" {% if order.status == '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ' %}selected{% endif %}>–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ</option>
                    <option value="–í—ã–¥–∞–Ω" {% if order.status == '–í—ã–¥–∞–Ω' %}selected{% endif %}>–í—ã–¥–∞–Ω</option>
                    <option value="–û—Ç–º–µ–Ω–µ–Ω" {% if order.status == '–û—Ç–º–µ–Ω–µ–Ω' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω</option>
                </select>
            </div>
            {% else %}
            <div class="info-item">
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <div class="info-value">
                    <span class="status status-{{ order.status.lower().replace(' ', '-') }}">
                        {{ order.status }}
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if ordered_items %}
    <div class="form-section">
        <h3>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
        <table class="items-table">
            <thead>
                <tr>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–¶–µ–Ω–∞ –∑–∞ –µ–¥.</th>
                    <th>–°—É–º–º–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for item in ordered_items %}
                <tr>
                    <td>{{ item.invoice.good.name if item.invoice and item.invoice.good else '–¢–æ–≤–∞—Ä –Ω–µ —É–∫–∞–∑–∞–Ω' }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ "%.2f"|format(item.price_per_unit|float) }} ‚ÇΩ</td>
                    <td>{{ "%.2f"|format(item.subtotal|float) }} ‚ÇΩ</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if order.receipt %}
    <div class="form-section">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–µ–∫–µ</h3>
        
        <div class="info-row">
            <div class="info-item">
                <label>–ù–æ–º–µ—Ä —á–µ–∫–∞:</label>
                <div class="info-value"><strong>{{ order.receipt.receipt_number }}</strong></div>
            </div>
            
            <div class="info-item">
                <label>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</label>
                <div class="info-value">
                    {% if order.receipt.date_oforder %}
                        {{ order.receipt.date_oforder.strftime('%d.%m.%Y') }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="payment_method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
                {% if user_type == 'staff' and editable %}
                <select id="payment_method" name="payment_method">
                    <option value="–ù–µ –æ–ø–ª–∞—á–µ–Ω" {% if order.receipt.payment_method == '–ù–µ –æ–ø–ª–∞—á–µ–Ω' %}selected{% endif %}>–ù–µ –æ–ø–ª–∞—á–µ–Ω</option>
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ" {% if order.receipt.payment_method == '–ù–∞–ª–∏—á–Ω—ã–µ' %}selected{% endif %}>–ù–∞–ª–∏—á–Ω—ã–µ</option>
                    <option value="–ö–∞—Ä—Ç–∞" {% if order.receipt.payment_method == '–ö–∞—Ä—Ç–∞' %}selected{% endif %}>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                    <option value="–û–Ω–ª–∞–π–Ω" {% if order.receipt.payment_method == '–û–Ω–ª–∞–π–Ω' %}selected{% endif %}>–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞</option>
                    <option value="–ü–µ—Ä–µ–≤–æ–¥" {% if order.receipt.payment_method == '–ü–µ—Ä–µ–≤–æ–¥' %}selected{% endif %}>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option>
                    <option value="–í–æ–∑–≤—Ä–∞—Ç" {% if order.receipt.payment_method == '–í–æ–∑–≤—Ä–∞—Ç' %}selected{% endif %}>–í–æ–∑–≤—Ä–∞—Ç</option>
                </select>
                {% else %}
                <div class="info-value">{{ order.receipt.payment_method }}</div>
                {% endif %}
            </div>
            
            <div class="info-item">
                <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
                <div class="info-value">
                    {% if order.receipt.worker %}
                        {{ order.receipt.worker.name }}
                    {% else %}
                        –ù–µ —É–∫–∞–∑–∞–Ω
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="form-actions">
        {% if editable and user_type == 'staff' %}
            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        {% endif %}
        <a href="{{ url_for('staff_orders') if user_type == 'staff' else url_for('customer_orders') }}" 
           class="btn">–ù–∞–∑–∞–¥</a>
    </div>
</form>
{% endblock %}
